(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const e of t)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function i(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?e.credentials="include":t.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function o(t){if(t.ep)return;t.ep=!0;const e=i(t);fetch(t.href,e)}})();function kt(a){if(Object.prototype.hasOwnProperty.call(a,"__esModule"))return a;var s=a.default;if(typeof s=="function"){var i=function o(){return this instanceof o?Reflect.construct(s,arguments,this.constructor):s.apply(this,arguments)};i.prototype=s.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(a).forEach(function(o){var t=Object.getOwnPropertyDescriptor(a,o);Object.defineProperty(i,o,t.get?t:{enumerable:!0,get:function(){return a[o]}})}),i}var ie={},ve,je;function wt(){if(je)return ve;je=1;function a(t){var e=new o(t),n=e.readChunk();if(n.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+n.id+"'";for(var l=s(n.data),u=[],c=0;!e.eof()&&c<l.numTracks;c++){var r=e.readChunk();if(r.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+r.id+"'";var d=i(r.data);u.push(d)}return{header:l,tracks:u}}function s(t){var e=new o(t),n=e.readUInt16(),l=e.readUInt16(),u={format:n,numTracks:l},c=e.readUInt16();return c&32768?(u.framesPerSecond=256-(c>>8),u.ticksPerFrame=c&255):u.ticksPerBeat=c,u}function i(t){for(var e=new o(t),n=[];!e.eof();){var l=c();n.push(l)}return n;var u;function c(){var r={};r.deltaTime=e.readVarInt();var d=e.readUInt8();if((d&240)===240)if(d===255){r.meta=!0;var f=e.readUInt8(),h=e.readVarInt();switch(f){case 0:if(r.type="sequenceNumber",h!==2)throw"Expected length for sequenceNumber event is 2, got "+h;return r.number=e.readUInt16(),r;case 1:return r.type="text",r.text=e.readString(h),r;case 2:return r.type="copyrightNotice",r.text=e.readString(h),r;case 3:return r.type="trackName",r.text=e.readString(h),r;case 4:return r.type="instrumentName",r.text=e.readString(h),r;case 5:return r.type="lyrics",r.text=e.readString(h),r;case 6:return r.type="marker",r.text=e.readString(h),r;case 7:return r.type="cuePoint",r.text=e.readString(h),r;case 32:if(r.type="channelPrefix",h!=1)throw"Expected length for channelPrefix event is 1, got "+h;return r.channel=e.readUInt8(),r;case 33:if(r.type="portPrefix",h!=1)throw"Expected length for portPrefix event is 1, got "+h;return r.port=e.readUInt8(),r;case 47:if(r.type="endOfTrack",h!=0)throw"Expected length for endOfTrack event is 0, got "+h;return r;case 81:if(r.type="setTempo",h!=3)throw"Expected length for setTempo event is 3, got "+h;return r.microsecondsPerBeat=e.readUInt24(),r;case 84:if(r.type="smpteOffset",h!=5)throw"Expected length for smpteOffset event is 5, got "+h;var T=e.readUInt8(),k={0:24,32:25,64:29,96:30};return r.frameRate=k[T&96],r.hour=T&31,r.min=e.readUInt8(),r.sec=e.readUInt8(),r.frame=e.readUInt8(),r.subFrame=e.readUInt8(),r;case 88:if(r.type="timeSignature",h!=2&&h!=4)throw"Expected length for timeSignature event is 4 or 2, got "+h;return r.numerator=e.readUInt8(),r.denominator=1<<e.readUInt8(),h===4?(r.metronome=e.readUInt8(),r.thirtyseconds=e.readUInt8()):(r.metronome=36,r.thirtyseconds=8),r;case 89:if(r.type="keySignature",h!=2)throw"Expected length for keySignature event is 2, got "+h;return r.key=e.readInt8(),r.scale=e.readUInt8(),r;case 127:return r.type="sequencerSpecific",r.data=e.readBytes(h),r;default:return r.type="unknownMeta",r.data=e.readBytes(h),r.metatypeByte=f,r}}else if(d==240){r.type="sysEx";var h=e.readVarInt();return r.data=e.readBytes(h),r}else if(d==247){r.type="endSysEx";var h=e.readVarInt();return r.data=e.readBytes(h),r}else throw"Unrecognised MIDI event type byte: "+d;else{var y;if((d&128)===0){if(u===null)throw"Running status byte encountered before status byte";y=d,d=u,r.running=!0}else y=e.readUInt8(),u=d;var m=d>>4;switch(r.channel=d&15,m){case 8:return r.type="noteOff",r.noteNumber=y,r.velocity=e.readUInt8(),r;case 9:var b=e.readUInt8();return r.type=b===0?"noteOff":"noteOn",r.noteNumber=y,r.velocity=b,b===0&&(r.byte9=!0),r;case 10:return r.type="noteAftertouch",r.noteNumber=y,r.amount=e.readUInt8(),r;case 11:return r.type="controller",r.controllerType=y,r.value=e.readUInt8(),r;case 12:return r.type="programChange",r.programNumber=y,r;case 13:return r.type="channelAftertouch",r.amount=y,r;case 14:return r.type="pitchBend",r.value=y+(e.readUInt8()<<7)-8192,r;default:throw"Unrecognised MIDI event type: "+m}}}}function o(t){this.buffer=t,this.bufferLen=this.buffer.length,this.pos=0}return o.prototype.eof=function(){return this.pos>=this.bufferLen},o.prototype.readUInt8=function(){var t=this.buffer[this.pos];return this.pos+=1,t},o.prototype.readInt8=function(){var t=this.readUInt8();return t&128?t-256:t},o.prototype.readUInt16=function(){var t=this.readUInt8(),e=this.readUInt8();return(t<<8)+e},o.prototype.readInt16=function(){var t=this.readUInt16();return t&32768?t-65536:t},o.prototype.readUInt24=function(){var t=this.readUInt8(),e=this.readUInt8(),n=this.readUInt8();return(t<<16)+(e<<8)+n},o.prototype.readInt24=function(){var t=this.readUInt24();return t&8388608?t-16777216:t},o.prototype.readUInt32=function(){var t=this.readUInt8(),e=this.readUInt8(),n=this.readUInt8(),l=this.readUInt8();return(t<<24)+(e<<16)+(n<<8)+l},o.prototype.readBytes=function(t){var e=this.buffer.slice(this.pos,this.pos+t);return this.pos+=t,e},o.prototype.readString=function(t){var e=this.readBytes(t);return String.fromCharCode.apply(null,e)},o.prototype.readVarInt=function(){for(var t=0;!this.eof();){var e=this.readUInt8();if(e&128)t+=e&127,t<<=7;else return t+e}return t},o.prototype.readChunk=function(){var t=this.readString(4),e=this.readUInt32(),n=this.readBytes(e);return{id:t,length:e,data:n}},ve=a,ve}var be,He;function Tt(){if(He)return be;He=1;function a(e,n){if(typeof e!="object")throw"Invalid MIDI data";n=n||{};var l=e.header||{},u=e.tracks||[],c,r=u.length,d=new t;for(s(d,l,r),c=0;c<r;c++)i(d,u[c],n);return d.buffer}function s(e,n,l){var u=n.format==null?1:n.format,c=128;n.timeDivision?c=n.timeDivision:n.ticksPerFrame&&n.framesPerSecond?c=-(n.framesPerSecond&255)<<8|n.ticksPerFrame&255:n.ticksPerBeat&&(c=n.ticksPerBeat&32767);var r=new t;r.writeUInt16(u),r.writeUInt16(l),r.writeUInt16(c),e.writeChunk("MThd",r.buffer)}function i(e,n,l){var u=new t,c,r=n.length,d=null;for(c=0;c<r;c++)(l.running===!1||!l.running&&!n[c].running)&&(d=null),d=o(u,n[c],d,l.useByte9ForNoteOff);e.writeChunk("MTrk",u.buffer)}function o(e,n,l,u){var c=n.type,r=n.deltaTime,d=n.text||"",f=n.data||[],h=null;switch(e.writeVarInt(r),c){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(n.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(d.length),e.writeString(d);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(d.length),e.writeString(d);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(d.length),e.writeString(d);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(d.length),e.writeString(d);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(d.length),e.writeString(d);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(d.length),e.writeString(d);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(d.length),e.writeString(d);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(n.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(n.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(n.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var T={24:0,25:32,29:64,30:96},k=n.hour&31|T[n.frameRate];e.writeUInt8(k),e.writeUInt8(n.min),e.writeUInt8(n.sec),e.writeUInt8(n.frame),e.writeUInt8(n.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(n.numerator);var y=Math.floor(Math.log(n.denominator)/Math.LN2)&255;e.writeUInt8(y),e.writeUInt8(n.metronome),e.writeUInt8(n.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(n.key),e.writeUInt8(n.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(f.length),e.writeBytes(f);break;case"unknownMeta":n.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(n.metatypeByte),e.writeVarInt(f.length),e.writeBytes(f));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(f.length),e.writeBytes(f);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(f.length),e.writeBytes(f);break;case"noteOff":var m=u!==!1&&n.byte9||u&&n.velocity==0?144:128;h=m|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.noteNumber),e.writeUInt8(n.velocity);break;case"noteOn":h=144|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.noteNumber),e.writeUInt8(n.velocity);break;case"noteAftertouch":h=160|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.noteNumber),e.writeUInt8(n.amount);break;case"controller":h=176|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.controllerType),e.writeUInt8(n.value);break;case"programChange":h=192|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.programNumber);break;case"channelAftertouch":h=208|n.channel,h!==l&&e.writeUInt8(h),e.writeUInt8(n.amount);break;case"pitchBend":h=224|n.channel,h!==l&&e.writeUInt8(h);var b=8192+n.value,v=b&127,p=b>>7&127;e.writeUInt8(v),e.writeUInt8(p);break;default:throw"Unrecognized event type: "+c}return h}function t(){this.buffer=[]}return t.prototype.writeUInt8=function(e){this.buffer.push(e&255)},t.prototype.writeInt8=t.prototype.writeUInt8,t.prototype.writeUInt16=function(e){var n=e>>8&255,l=e&255;this.writeUInt8(n),this.writeUInt8(l)},t.prototype.writeInt16=t.prototype.writeUInt16,t.prototype.writeUInt24=function(e){var n=e>>16&255,l=e>>8&255,u=e&255;this.writeUInt8(n),this.writeUInt8(l),this.writeUInt8(u)},t.prototype.writeInt24=t.prototype.writeUInt24,t.prototype.writeUInt32=function(e){var n=e>>24&255,l=e>>16&255,u=e>>8&255,c=e&255;this.writeUInt8(n),this.writeUInt8(l),this.writeUInt8(u),this.writeUInt8(c)},t.prototype.writeInt32=t.prototype.writeUInt32,t.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},t.prototype.writeString=function(e){var n,l=e.length,u=[];for(n=0;n<l;n++)u.push(e.codePointAt(n));this.writeBytes(u)},t.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var n=e,l=[];for(l.push(n&127),n>>=7;n;){var u=n&127|128;l.push(u),n>>=7}this.writeBytes(l.reverse())}},t.prototype.writeChunk=function(e,n){this.writeString(e),this.writeUInt32(n.length),this.writeBytes(n)},be=a,be}var Re;function Ce(){return Re||(Re=1,ie.parseMidi=wt(),ie.writeMidi=Tt()),ie}var xt=Ce(),K={},Ie={},W={},Je;function dt(){if(Je)return W;Je=1,Object.defineProperty(W,"__esModule",{value:!0}),W.insert=W.search=void 0;function a(i,o,t){t===void 0&&(t="ticks");var e=0,n=i.length,l=n;if(n>0&&i[n-1][t]<=o)return n-1;for(;e<l;){var u=Math.floor(e+(l-e)/2),c=i[u],r=i[u+1];if(c[t]===o){for(var d=u;d<i.length;d++){var f=i[d];f[t]===o&&(u=d)}return u}else{if(c[t]<o&&r[t]>o)return u;c[t]>o?l=u:c[t]<o&&(e=u+1)}}return-1}W.search=a;function s(i,o,t){if(t===void 0&&(t="ticks"),i.length){var e=a(i,o[t],t);i.splice(e+1,0,o)}else i.push(o)}return W.insert=s,W}var $e;function we(){return $e||($e=1,function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.Header=a.keySignatureKeys=void 0;var s=dt(),i=new WeakMap;a.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var o=function(){function t(e){var n=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",i.set(this,480),e){i.set(this,e.header.ticksPerBeat),e.tracks.forEach(function(u){u.forEach(function(c){c.meta&&(c.type==="timeSignature"?n.timeSignatures.push({ticks:c.absoluteTime,timeSignature:[c.numerator,c.denominator]}):c.type==="setTempo"?n.tempos.push({bpm:6e7/c.microsecondsPerBeat,ticks:c.absoluteTime}):c.type==="keySignature"&&n.keySignatures.push({key:a.keySignatureKeys[c.key+7],scale:c.scale===0?"major":"minor",ticks:c.absoluteTime}))})});var l=0;e.tracks[0].forEach(function(u){l+=u.deltaTime,u.meta&&(u.type==="trackName"?n.name=u.text:(u.type==="text"||u.type==="cuePoint"||u.type==="marker"||u.type==="lyrics")&&n.meta.push({text:u.text,ticks:l,type:u.type}))}),this.update()}}return t.prototype.update=function(){var e=this,n=0,l=0;this.tempos.sort(function(u,c){return u.ticks-c.ticks}),this.tempos.forEach(function(u,c){var r=c>0?e.tempos[c-1].bpm:e.tempos[0].bpm,d=u.ticks/e.ppq-l,f=60/r*d;u.time=f+n,n=u.time,l+=d}),this.timeSignatures.sort(function(u,c){return u.ticks-c.ticks}),this.timeSignatures.forEach(function(u,c){var r=c>0?e.timeSignatures[c-1]:e.timeSignatures[0],d=(u.ticks-r.ticks)/e.ppq,f=d/r.timeSignature[0]/(r.timeSignature[1]/4);r.measures=r.measures||0,u.measures=f+r.measures})},t.prototype.ticksToSeconds=function(e){var n=(0,s.search)(this.tempos,e);if(n!==-1){var l=this.tempos[n],u=l.time,c=(e-l.ticks)/this.ppq;return u+60/l.bpm*c}else{var r=e/this.ppq;return 60/120*r}},t.prototype.ticksToMeasures=function(e){var n=(0,s.search)(this.timeSignatures,e);if(n!==-1){var l=this.timeSignatures[n],u=(e-l.ticks)/this.ppq;return l.measures+u/(l.timeSignature[0]/l.timeSignature[1])/4}else return e/this.ppq/4},Object.defineProperty(t.prototype,"ppq",{get:function(){return i.get(this)},enumerable:!1,configurable:!0}),t.prototype.secondsToTicks=function(e){var n=(0,s.search)(this.tempos,e,"time");if(n!==-1){var l=this.tempos[n],u=l.time,c=e-u,r=c/(60/l.bpm);return Math.round(l.ticks+r*this.ppq)}else{var d=e/.5;return Math.round(d*this.ppq)}},t.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(e){return{bpm:e.bpm,ticks:e.ticks}}),timeSignatures:this.timeSignatures}},t.prototype.fromJSON=function(e){this.name=e.name,this.tempos=e.tempos.map(function(n){return Object.assign({},n)}),this.timeSignatures=e.timeSignatures.map(function(n){return Object.assign({},n)}),this.keySignatures=e.keySignatures.map(function(n){return Object.assign({},n)}),this.meta=e.meta.map(function(n){return Object.assign({},n)}),i.set(this,e.ppq),this.update()},t.prototype.setTempo=function(e){this.tempos=[{bpm:e,ticks:0}],this.update()},t}();a.Header=o}(Ie)),Ie}var Y={},ke={},Ge;function ft(){return Ge||(Ge=1,function(a){Object.defineProperty(a,"__esModule",{value:!0}),a.ControlChange=a.controlChangeIds=a.controlChangeNames=void 0,a.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},a.controlChangeIds=Object.keys(a.controlChangeNames).reduce(function(t,e){return t[a.controlChangeNames[e]]=e,t},{});var s=new WeakMap,i=new WeakMap,o=function(){function t(e,n){s.set(this,n),i.set(this,e.controllerType),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(t.prototype,"number",{get:function(){return i.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"name",{get:function(){return a.controlChangeNames[this.number]?a.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"time",{get:function(){var e=s.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var n=s.get(this);this.ticks=n.secondsToTicks(e)},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},t}();a.ControlChange=o}(ke)),ke}var Z={},Ke;function Et(){if(Ke)return Z;Ke=1,Object.defineProperty(Z,"__esModule",{value:!0}),Z.createControlChanges=void 0;var a=ft();function s(){return new Proxy({},{get:function(i,o){if(i[o])return i[o];if(a.controlChangeIds.hasOwnProperty(o))return i[a.controlChangeIds[o]]},set:function(i,o,t){return a.controlChangeIds.hasOwnProperty(o)?i[a.controlChangeIds[o]]=t:i[o]=t,!0}})}return Z.createControlChanges=s,Z}var ee={},We;function Mt(){if(We)return ee;We=1,Object.defineProperty(ee,"__esModule",{value:!0}),ee.PitchBend=void 0;var a=new WeakMap,s=function(){function i(o,t){a.set(this,t),this.ticks=o.absoluteTime,this.value=o.value}return Object.defineProperty(i.prototype,"time",{get:function(){var o=a.get(this);return o.ticksToSeconds(this.ticks)},set:function(o){var t=a.get(this);this.ticks=t.secondsToTicks(o)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},i}();return ee.PitchBend=s,ee}var te={},G={},ze;function St(){return ze||(ze=1,Object.defineProperty(G,"__esModule",{value:!0}),G.DrumKitByPatchID=G.InstrumentFamilyByID=G.instrumentByPatchID=void 0,G.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],G.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],G.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),G}var Xe;function Ut(){if(Xe)return te;Xe=1,Object.defineProperty(te,"__esModule",{value:!0}),te.Instrument=void 0;var a=St(),s=new WeakMap,i=function(){function o(t,e){if(this.number=0,s.set(this,e),this.number=0,t){var n=t.find(function(l){return l.type==="programChange"});n&&(this.number=n.programNumber)}}return Object.defineProperty(o.prototype,"name",{get:function(){return this.percussion?a.DrumKitByPatchID[this.number]:a.instrumentByPatchID[this.number]},set:function(t){var e=a.instrumentByPatchID.indexOf(t);e!==-1&&(this.number=e)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"family",{get:function(){return this.percussion?"drums":a.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"percussion",{get:function(){var t=s.get(this);return t.channel===9},enumerable:!1,configurable:!0}),o.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},o.prototype.fromJSON=function(t){this.number=t.number},o}();return te.Instrument=i,te}var ne={},Qe;function Ct(){if(Qe)return ne;Qe=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.Note=void 0;function a(n){var l=Math.floor(n/12)-1;return s(n)+l.toString()}function s(n){var l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],u=n%12;return l[u]}function i(n){var l=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return l.indexOf(n)}var o=function(){var n=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,l={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(u){var c=n.exec(u),r=c[1],d=c[2],f=l[r.toLowerCase()];return f+(parseInt(d,10)+1)*12}}(),t=new WeakMap,e=function(){function n(l,u,c){t.set(this,c),this.midi=l.midi,this.velocity=l.velocity,this.noteOffVelocity=u.velocity,this.ticks=l.ticks,this.durationTicks=u.ticks-l.ticks}return Object.defineProperty(n.prototype,"name",{get:function(){return a(this.midi)},set:function(l){this.midi=o(l)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(l){var u=l-this.octave;this.midi+=u*12},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"pitch",{get:function(){return s(this.midi)},set:function(l){this.midi=12*(this.octave+1)+i(l)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){var l=t.get(this);return l.ticksToSeconds(this.ticks+this.durationTicks)-l.ticksToSeconds(this.ticks)},set:function(l){var u=t.get(this),c=u.secondsToTicks(this.time+l);this.durationTicks=c-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"time",{get:function(){var l=t.get(this);return l.ticksToSeconds(this.ticks)},set:function(l){var u=t.get(this);this.ticks=u.secondsToTicks(l)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"bars",{get:function(){var l=t.get(this);return l.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},n}();return ne.Note=e,ne}var Ye;function Ze(){if(Ye)return Y;Ye=1,Object.defineProperty(Y,"__esModule",{value:!0}),Y.Track=void 0;var a=dt(),s=ft(),i=Et(),o=Mt(),t=Ut(),e=Ct(),n=new WeakMap,l=function(){function u(c,r){var d=this;if(this.name="",this.notes=[],this.controlChanges=(0,i.createControlChanges)(),this.pitchBends=[],n.set(this,r),c){var f=c.find(function(p){return p.type==="trackName"});this.name=f?f.text:""}if(this.instrument=new t.Instrument(c,this),this.channel=0,c){for(var h=c.filter(function(p){return p.type==="noteOn"}),T=c.filter(function(p){return p.type==="noteOff"}),k=function(){var p=h.shift();y.channel=p.channel;var g=T.findIndex(function(M){return M.noteNumber===p.noteNumber&&M.absoluteTime>=p.absoluteTime});if(g!==-1){var E=T.splice(g,1)[0];y.addNote({durationTicks:E.absoluteTime-p.absoluteTime,midi:p.noteNumber,noteOffVelocity:E.velocity/127,ticks:p.absoluteTime,velocity:p.velocity/127})}},y=this;h.length;)k();var m=c.filter(function(p){return p.type==="controller"});m.forEach(function(p){d.addCC({number:p.controllerType,ticks:p.absoluteTime,value:p.value/127})});var b=c.filter(function(p){return p.type==="pitchBend"});b.forEach(function(p){d.addPitchBend({ticks:p.absoluteTime,value:p.value/Math.pow(2,13)})});var v=c.find(function(p){return p.type==="endOfTrack"});this.endOfTrackTicks=v!==void 0?v.absoluteTime:void 0}}return u.prototype.addNote=function(c){var r=n.get(this),d=new e.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},r);return Object.assign(d,c),(0,a.insert)(this.notes,d,"ticks"),this},u.prototype.addCC=function(c){var r=n.get(this),d=new s.ControlChange({controllerType:c.number},r);return delete c.number,Object.assign(d,c),Array.isArray(this.controlChanges[d.number])||(this.controlChanges[d.number]=[]),(0,a.insert)(this.controlChanges[d.number],d,"ticks"),this},u.prototype.addPitchBend=function(c){var r=n.get(this),d=new o.PitchBend({},r);return Object.assign(d,c),(0,a.insert)(this.pitchBends,d,"ticks"),this},Object.defineProperty(u.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var c=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,r=0;r<this.notes.length-1;r++){var d=this.notes[r].time+this.notes[r].duration;c<d&&(c=d)}return c},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var c=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,r=0;r<this.notes.length-1;r++){var d=this.notes[r].ticks+this.notes[r].durationTicks;c<d&&(c=d)}return c},enumerable:!1,configurable:!0}),u.prototype.fromJSON=function(c){var r=this;this.name=c.name,this.channel=c.channel,this.instrument=new t.Instrument(void 0,this),this.instrument.fromJSON(c.instrument),c.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=c.endOfTrackTicks);for(var d in c.controlChanges)c.controlChanges[d]&&c.controlChanges[d].forEach(function(f){r.addCC({number:f.number,ticks:f.ticks,value:f.value})});c.notes.forEach(function(f){r.addNote({durationTicks:f.durationTicks,midi:f.midi,ticks:f.ticks,velocity:f.velocity})})},u.prototype.toJSON=function(){for(var c={},r=0;r<127;r++)this.controlChanges.hasOwnProperty(r)&&(c[r]=this.controlChanges[r].map(function(f){return f.toJSON()}));var d={channel:this.channel,controlChanges:c,pitchBends:this.pitchBends.map(function(f){return f.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(f){return f.toJSON()})};return this.endOfTrackTicks!==void 0&&(d.endOfTrackTicks=this.endOfTrackTicks),d},u}();return Y.Track=l,Y}var z={};function Pt(a){var s=[];return ht(a,s),s}function ht(a,s){for(var i=0;i<a.length;i++){var o=a[i];Array.isArray(o)?ht(o,s):s.push(o)}}const Bt=Object.freeze(Object.defineProperty({__proto__:null,flatten:Pt},Symbol.toStringTag,{value:"Module"})),Ot=kt(Bt);var et;function Nt(){if(et)return z;et=1;var a=z&&z.__spreadArray||function(m,b,v){if(v||arguments.length===2)for(var p=0,g=b.length,E;p<g;p++)(E||!(p in b))&&(E||(E=Array.prototype.slice.call(b,0,p)),E[p]=b[p]);return m.concat(E||Array.prototype.slice.call(b))};Object.defineProperty(z,"__esModule",{value:!0}),z.encode=void 0;var s=Ce(),i=we(),o=Ot;function t(m,b){return[{absoluteTime:m.ticks,channel:b,deltaTime:0,noteNumber:m.midi,type:"noteOn",velocity:Math.floor(m.velocity*127)},{absoluteTime:m.ticks+m.durationTicks,channel:b,deltaTime:0,noteNumber:m.midi,type:"noteOff",velocity:Math.floor(m.noteOffVelocity*127)}]}function e(m){return(0,o.flatten)(m.notes.map(function(b){return t(b,m.channel)}))}function n(m,b){return{absoluteTime:m.ticks,channel:b,controllerType:m.number,deltaTime:0,type:"controller",value:Math.floor(m.value*127)}}function l(m){for(var b=[],v=0;v<127;v++)m.controlChanges.hasOwnProperty(v)&&m.controlChanges[v].forEach(function(p){b.push(n(p,m.channel))});return b}function u(m,b){return{absoluteTime:m.ticks,channel:b,deltaTime:0,type:"pitchBend",value:m.value}}function c(m){var b=[];return m.pitchBends.forEach(function(v){b.push(u(v,m.channel))}),b}function r(m){return{absoluteTime:0,channel:m.channel,deltaTime:0,programNumber:m.instrument.number,type:"programChange"}}function d(m){return{absoluteTime:0,deltaTime:0,meta:!0,text:m,type:"trackName"}}function f(m){return{absoluteTime:m.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/m.bpm),type:"setTempo"}}function h(m){return{absoluteTime:m.ticks,deltaTime:0,denominator:m.timeSignature[1],meta:!0,metronome:24,numerator:m.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function T(m){var b=i.keySignatureKeys.indexOf(m.key);return{absoluteTime:m.ticks,deltaTime:0,key:b+7,meta:!0,scale:m.scale==="major"?0:1,type:"keySignature"}}function k(m){return{absoluteTime:m.ticks,deltaTime:0,meta:!0,text:m.text,type:m.type}}function y(m){var b={header:{format:1,numTracks:m.tracks.length+1,ticksPerBeat:m.header.ppq},tracks:a([a(a(a(a([{absoluteTime:0,deltaTime:0,meta:!0,text:m.header.name,type:"trackName"}],m.header.keySignatures.map(function(v){return T(v)}),!0),m.header.meta.map(function(v){return k(v)}),!0),m.header.tempos.map(function(v){return f(v)}),!0),m.header.timeSignatures.map(function(v){return h(v)}),!0)],m.tracks.map(function(v){return a(a(a([d(v.name),r(v)],e(v),!0),l(v),!0),c(v),!0)}),!0)};return b.tracks=b.tracks.map(function(v){v=v.sort(function(g,E){return g.absoluteTime-E.absoluteTime});var p=0;return v.forEach(function(g){g.deltaTime=g.absoluteTime-p,p=g.absoluteTime,delete g.absoluteTime}),v.push({deltaTime:0,meta:!0,type:"endOfTrack"}),v}),new Uint8Array((0,s.writeMidi)(b))}return z.encode=y,z}var tt;function Ft(){return tt||(tt=1,function(a){var s=K&&K.__awaiter||function(d,f,h,T){function k(y){return y instanceof h?y:new h(function(m){m(y)})}return new(h||(h=Promise))(function(y,m){function b(g){try{p(T.next(g))}catch(E){m(E)}}function v(g){try{p(T.throw(g))}catch(E){m(E)}}function p(g){g.done?y(g.value):k(g.value).then(b,v)}p((T=T.apply(d,f||[])).next())})},i=K&&K.__generator||function(d,f){var h={label:0,sent:function(){if(y[0]&1)throw y[1];return y[1]},trys:[],ops:[]},T,k,y,m;return m={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(m[Symbol.iterator]=function(){return this}),m;function b(p){return function(g){return v([p,g])}}function v(p){if(T)throw new TypeError("Generator is already executing.");for(;h;)try{if(T=1,k&&(y=p[0]&2?k.return:p[0]?k.throw||((y=k.return)&&y.call(k),0):k.next)&&!(y=y.call(k,p[1])).done)return y;switch(k=0,y&&(p=[p[0]&2,y.value]),p[0]){case 0:case 1:y=p;break;case 4:return h.label++,{value:p[1],done:!1};case 5:h.label++,k=p[1],p=[0];continue;case 7:p=h.ops.pop(),h.trys.pop();continue;default:if(y=h.trys,!(y=y.length>0&&y[y.length-1])&&(p[0]===6||p[0]===2)){h=0;continue}if(p[0]===3&&(!y||p[1]>y[0]&&p[1]<y[3])){h.label=p[1];break}if(p[0]===6&&h.label<y[1]){h.label=y[1],y=p;break}if(y&&h.label<y[2]){h.label=y[2],h.ops.push(p);break}y[2]&&h.ops.pop(),h.trys.pop();continue}p=f.call(d,h)}catch(g){p=[6,g],k=0}finally{T=y=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}};Object.defineProperty(a,"__esModule",{value:!0}),a.Header=a.Track=a.Midi=void 0;var o=Ce(),t=we(),e=Ze(),n=Nt(),l=function(){function d(f){var h=this,T=null;if(f){var k=f instanceof ArrayBuffer?new Uint8Array(f):f;T=(0,o.parseMidi)(k),T.tracks.forEach(function(y){var m=0;y.forEach(function(b){m+=b.deltaTime,b.absoluteTime=m})}),T.tracks=r(T.tracks)}this.header=new t.Header(T),this.tracks=[],f&&(this.tracks=T.tracks.map(function(y){return new e.Track(y,h.header)}),T.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return d.fromUrl=function(f){return s(this,void 0,void 0,function(){var h,T;return i(this,function(k){switch(k.label){case 0:return[4,fetch(f)];case 1:return h=k.sent(),h.ok?[4,h.arrayBuffer()]:[3,3];case 2:return T=k.sent(),[2,new d(T)];case 3:throw new Error("Could not load '".concat(f,"'"))}})})},Object.defineProperty(d.prototype,"name",{get:function(){return this.header.name},set:function(f){this.header.name=f},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"duration",{get:function(){var f=this.tracks.map(function(h){return h.duration});return Math.max.apply(Math,f)},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"durationTicks",{get:function(){var f=this.tracks.map(function(h){return h.durationTicks});return Math.max.apply(Math,f)},enumerable:!1,configurable:!0}),d.prototype.addTrack=function(){var f=new e.Track(void 0,this.header);return this.tracks.push(f),f},d.prototype.toArray=function(){return(0,n.encode)(this)},d.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(f){return f.toJSON()})}},d.prototype.fromJSON=function(f){var h=this;this.header=new t.Header,this.header.fromJSON(f.header),this.tracks=f.tracks.map(function(T){var k=new e.Track(void 0,h.header);return k.fromJSON(T),k})},d.prototype.clone=function(){var f=new d;return f.fromJSON(this.toJSON()),f},d}();a.Midi=l;var u=Ze();Object.defineProperty(a,"Track",{enumerable:!0,get:function(){return u.Track}});var c=we();Object.defineProperty(a,"Header",{enumerable:!0,get:function(){return c.Header}});function r(d){for(var f=[],h=0;h<d.length;h++)for(var T=f.length,k=new Map,y=Array(16).fill(0),m=0,b=d[h];m<b.length;m++){var v=b[m],p=T,g=v.channel;if(g!==void 0){v.type==="programChange"&&(y[g]=v.programNumber);var E=y[g],M="".concat(E," ").concat(g);k.has(M)?p=k.get(M):(p=T+k.size,k.set(M,p))}f[p]||f.push([]),f[p].push(v)}return f}}(K)),K}var nt=Ft();let se,N,B={},F={},V={},oe=!1,Lt=.66,X=.001,j=.001,Pe=0,Be=0,ce=1,C=[{attack:X,release:j},{volume:1}],ae={},re,mt,rt,it,ot,at,Te,xe,Ee,Me,st,ct,H,Se,_,Dt=27.5;document.addEventListener("DOMContentLoaded",async()=>{await qt(),yt(),Rt(),Vt(),zt(),await Xt(),Yt()});async function qt(){try{const a=await fetch("harmonic-presets.json");if(!a.ok)throw new Error(`HTTP Error! Status: ${a.status}`);ae=await a.json(),At()}catch(a){return console.error("Error loading presets: ",a),document.getElementById("harmonic-presets-container").innerHTML+='<p class="error">Failed to load presets</p>',!1}}function At(){const a=document.getElementById("harmonic-presets-dropdown");for(;a.options.length>1;)a.remove(1);for(const s in ae){const i=document.createElement("optgroup");i.label=s;for(const o in ae[s]){const t=document.createElement("option");t.value=JSON.stringify(ae[s][o]),t.textContent=o,i.appendChild(t)}a.appendChild(i)}a.addEventListener("change",function(){if(this.selectedIndex!==0)try{C=JSON.parse(JSON.stringify(JSON.parse(this.value))),pt(),ue()}catch{console.error("Invalid preset selection:",error)}})}function Vt(){rt=document.getElementById("harmonic-add"),it=document.getElementById("harmonic-remove"),Te=document.getElementById("harmonic-attack-slider"),xe=document.getElementById("harmonic-release-slider"),ot=document.getElementById("transpose-semitones-slider"),at=document.getElementById("transpose-cents-slider"),Ee=document.getElementById("harmonic-attack-value-label"),Me=document.getElementById("harmonic-release-value-label"),st=document.getElementById("transpose-semitones-value-label"),ct=document.getElementById("transpose-cents-value-label"),mt=document.getElementById("harmonic-row"),re=document.getElementById("harmonics-container"),re.innerHTML="",pt(),rt.addEventListener("click",()=>{_t()}),it.addEventListener("click",()=>{jt()}),Te.addEventListener("input",function(){X=parseFloat(this.value),Ee.innerHTML=this.value}),xe.addEventListener("input",function(){j=parseFloat(this.value),Me.innerHTML=this.value}),ot.addEventListener("input",function(){Pe=parseInt(this.value),st.innerHTML=parseInt(this.value),ut()}),at.addEventListener("input",function(){Be=parseInt(this.value),ct.innerHTML=parseInt(this.value),ut()})}function ut(){const a={...B,...F,...V};for(const s in a){const i=a[s];i.oscillators&&i.oscillators.forEach(({oscillator:o,gainNode:t,baseFrequency:e})=>{const n=Pe*100+Be,l=Math.pow(2,n/1200);e*=l,o.frequency.value=e})}}function _t(){C.slice(1).length<50&&(C.push({volume:1}),Oe(),ue())}function jt(){C.slice(1).length>1&&(C.pop(),Oe(),ue())}function pt(){re.innerHTML="",C.length>0&&C[0]&&(C[0].attack!==void 0&&(X=parseFloat(C[0].attack),Te.value=X.toString(),Ee.innerHTML=X.toString()),C[0].release!==void 0&&(j=parseFloat(C[0].release),xe.value=j.toString(),Me.innerHTML=j.toString())),Oe()}function Oe(){function a(s){const i=s%10,o=s%100;return i===1&&o!==11?"st":i===2&&o!==12?"nd":i===3&&o!==13?"rd":"th"}re.innerHTML="",C.forEach((s,i)=>{if(i!==0){const o=document.importNode(mt.content,!0),t=o.querySelector(".harmonic-label"),e=a(i);t&&(t.innerHTML=`${i}${e}`);const n=o.querySelector(".harmonic-volume-slider");n&&(n.value=s.volume,n.dataset.index=i,n.addEventListener("input",function(){const l=parseInt(this.dataset.index);C[l].volume=this.value,ue()})),re.appendChild(o)}})}function ue(){if(Object.keys(B).length===0&&Object.keys(F).length===0)return;let a=0;for(let o=0;o<C.slice(1).length;o++){const t=parseFloat(C.slice(1)[o].volume);a+=t*t}const s=a>0?1/Math.sqrt(a):0;function i(o){const{oscillators:t,gainNode:e}=o,n=t[0].oscillator.frequency.value;for(let l=0;l<Math.min(t.length,C.slice(1).length);l++){const u=parseFloat(C.slice(1)[l].volume);t[l].gainNode.gain.value=u*s}for(let l=t.length;l<C.slice(1).length;l++){const u=parseFloat(C.slice(1)[l].volume),c=N.currentTime,r=N.createOscillator(),d=n*(l+1);r.type="sine",r.frequency.value=d*ce;const f=N.createGain();f.gain.cancelScheduledValues(c),f.gain.setValueAtTime(0,c),f.gain.linearRampToValueAtTime(u*s,c+X),r.connect(f),f.connect(e),r.start(),t.push({oscillator:r,gainNode:f,baseFrequency:d})}if(t.length>C.slice(1).length){const l=N.currentTime;for(let u=C.slice(1).length;u<t.length;u++)t[u].oscillator.stop(l+j);t.length=C.slice(1).length}Ne()}for(const o in B)i(B[o]);for(const o in F)i(F[o])}function yt(){let a=document.getElementById("reset-audio");N=new(window.AudioContext||window.webkitAudioContext),document.addEventListener("click",()=>{N.state==="suspended"&&N.resume()}),a.addEventListener("click",()=>{Ht()})}function Ht(){if(N){const a={...B,...F,...V};for(const s in a){const i=a[s],o=N.currentTime;i.oscillators&&i.oscillators.forEach(({oscillator:t,gainNode:e})=>{try{t.stop(o),t.disconnect(),e.disconnect()}catch(n){console.error("Error stopping oscillator:",n)}})}N.close(),yt()}}async function Rt(){const a=document.querySelector(".midi-message");if(!navigator.requestMIDIAccess){a.textContent="MIDI is not supported in this browser";return}try{se=await navigator.requestMIDIAccess(),se.onstatechange=lt,a.textContent="Waiting for MIDI Device...",lt()}catch(s){a.textContent=`Failed to access to MIDI devices: ${s}`,console.error("MIDI Access Error:",s)}}function lt(a){if(!se)return;const s=document.querySelector(".midi-message"),i=se.inputs;if(i.forEach(o=>{o.onmidimessage=D}),i.size>0){const o=[];i.forEach(t=>o.push(t.name)),s.textContent=`Connected to: ${o.join(", ")}`}else s.textContent="Waiting for MIDI device to connect..."}function D(a,s=!1){const i=a.data[0],o=a.data[1],t=a.data[2];i===144&&(t>0?$t(o,t,s):Ue(o)),i===128&&Ue(o),i===176&&Gt(o,t),i===224&&Wt(t)}function Ne(){const a=Object.keys(B).length+Object.keys(F).length+Object.keys(V).length;if(a===0)return;const s=1/Math.sqrt(a),i=N.currentTime;for(const o in B){const{oscillators:t,gainNode:e,velocity:n}=B[o],u=n/127*Lt*s,c=e.gain.value;e.gain.cancelScheduledValues(i),e.gain.setValueAtTime(c,i),e.gain.linearRampToValueAtTime(u,i+X)}}function Jt(a){const s=Pe*100+Be,i=Math.pow(2,s/1200);return 440*Math.pow(2,(a-69)/12)*i}function $t(a,s,i=!1){const o={...B,...F,...V};if(Object.keys(o).length>=25)return;if(F[a]){const{oscillators:c,gainNode:r}=F[a],d=N.currentTime;r.gain.cancelScheduledValues(d),r.gain.setValueAtTime(r.gain.value,d),r.gain.linearRampToValueAtTime(0,d+j),c.forEach(({oscillator:f})=>{f.stop(d+j)}),delete F[a]}B[a]&&Ue(a);let t=[],e=Jt(a);const n=N.createGain();n.gain.value=0;let l=0;for(let c=0;c<C.slice(1).length;c++){const r=parseFloat(C.slice(1)[c].volume);l+=r*r}const u=l>0?1/Math.sqrt(l):0;for(let c=0;c<C.slice(1).length;c++){const r=N.createOscillator(),d=e*(c+1);r.type="sine",r.frequency.value=d*ce;const f=N.createGain();f.gain.value=C.slice(1)[c].volume*u,r.connect(f),f.connect(n),r.start(),t.push({oscillator:r,gainNode:f,baseFrequency:d})}n.connect(N.destination),B[a]={oscillators:t,gainNode:n,velocity:s,midiPlayerActivated:i},Ne()}function Ue(a){if(B[a])if(oe)F[a]=B[a],delete B[a];else{const{oscillators:s,gainNode:i}=B[a],o=N.currentTime;i.gain.cancelScheduledValues(o),i.gain.setValueAtTime(i.gain.value,o),i.gain.linearRampToValueAtTime(0,o+j),V[a]={oscillators:s,gainNode:i,releaseEnd:o+j},delete B[a],setTimeout(()=>{V[a]&&(s.forEach(({oscillator:t})=>{t.stop(o)}),delete V[a])},j*1e3),Ne()}}function Gt(a,s){if(a===64){const i=oe;oe=s>=64,i&&!oe&&Kt()}}function Kt(){for(const a in F){const{oscillators:s,gainNode:i}=F[a],o=N.currentTime;i.gain.cancelScheduledValues(o),i.gain.setValueAtTime(i.gain.value,o),i.gain.linearRampToValueAtTime(0,o+j),V[a]={oscillators:s,gainNode:i,releaseEnd:o+j},delete B[a],setTimeout(()=>{V[a]&&(s.forEach(({oscillator:t})=>{t.stop(o)}),delete V[a])},j*1e3)}F={}}function Wt(a){const s=a/127*4-2;ce=Math.pow(2,s/12);const i={...B,...F,...V};for(const o in i){const t=i[o];t&&t.oscillators.forEach(({oscillator:e,gainNode:n,baseFrequency:l})=>{e.frequency.value=l*ce})}}function zt(){if(H=document.getElementById("waveform-graph"),!H){console.error("Waveform graph not found");return}H.width=H.clientWidth,H.height=H.clientHeight,Se=window.getComputedStyle(H),_=H.getContext("2d"),gt()}function gt(){if(requestAnimationFrame(gt),!_)return;Se.backgroundColor?_.fillStyle=Se.backgroundColor:_.fillStyle="rgb(0, 0, 0)",_.fillRect(0,0,H.width,H.height);const a={...B,...F,...V};if(Object.keys(a).length===0)return;H.width;const s=[];let i=0;for(const u in a){const c=a[u],{oscillators:r,gainNode:d}=c,f=d.gain.value;for(let h=0;h<r.length;h++){const{oscillator:T,gainNode:k}=r[h],y=T.frequency.value,m=k.gain.value*f;s.push({frequency:y,amplitude:m}),i+=m}}function o(u){let c=0;for(const r of s)c+=r.amplitude*Math.sin(2*Math.PI*r.frequency*u);return i>1?c/i:c}const t=H.width,e=H.height,n=1/Dt,l=_.createLinearGradient(0,0,t,0);l.addColorStop(0,"rgb(255, 209, 69)"),l.addColorStop(.5,"rgb(255, 215, 0)"),l.addColorStop(1,"rgb(255, 180, 40)"),_.strokeStyle=l,_.shadowColor="rgb(255, 165, 0)",_.shadowBlur=12,_.lineWidth=2,_.beginPath();for(let u=0;u<t;u++){const c=u/t*n,d=(1-o(c))*e/2;u==0?_.moveTo(u,d):_.lineTo(u,d)}_.stroke()}async function Xt(){const a=document.getElementById("midi-player-select-dropdown"),s=document.getElementById("midi-player-upload-button"),i=document.getElementById("midi-current-file-label"),o=document.getElementById("midi-play"),t=document.getElementById("midi-loop-checkbox"),e=document.getElementById("midi-speed-control-bar"),n=document.getElementById("midi-speed-control-value"),l=document.getElementById("midi-progress-bar"),u=document.getElementById("midi-progress-fill"),c=document.getElementById("midi-progress-handle"),r=document.getElementById("midi-current-time"),d=document.getElementById("midi-total-time");let f,h=!1,T=!1,k=!1,y=1;await m(),p();async function m(){try{const g=await fetch("midi-files.json");if(!g.ok)throw new Error(`HTTP Error! Status: ${g.status}`);const E=await g.json();for(;a.options.length>1;)a.remove(1);for(const M in E){const S=document.createElement("optgroup");S.label=M;for(const P in E[M]){const U=E[M][P],L=U.name,x=U.path,$=document.createElement("option");$.value=x,$.dataset.name=L,$.textContent=L,S.appendChild($)}a.appendChild(S)}a.addEventListener("change",async M=>{if(M.target.selectedIndex!==0)try{const S=M.target.selectedOptions[0],U=`/${S.value}`,L=S.dataset.name;await b(U,L)}catch(S){console.error("Error loading MIDI file: ",S),i.innerHTML+="Error loading MIDI file"}})}catch(g){console.error("Error loading MIDI files: ",g),i.innerHTML+="Error loading MIDI files"}}s.addEventListener("change",async function(){try{const g=this.files[0];await b(g)}catch(g){console.error("Error loading MIDI file: ",g),i.innerHTML+="Error loading MIDI file"}});async function b(g,E=""){let M;try{if(typeof g=="string"){const L=await fetch(g);if(!L.ok)throw new Error(`HTTP error! status: ${L.status}`);M=await L.arrayBuffer(),i.innerHTML="MIDI File Loaded: "+E}else if(g instanceof File)M=await g.arrayBuffer(),i.innerHTML="MIDI File Loaded: "+g.name;else if(g instanceof ArrayBuffer)M=g;else throw new Error("Invalid source type. Must be a URL string, File, or ArrayBuffer");const S=new nt.Midi(M),P=v(S);console.log(P);const U=xt.parseMidi(new Uint8Array(P.toArray()));f&&(f.isPlaying&&f.pause(),f.timeoutId&&clearTimeout(f.timeoutId),o.textContent="Play",o.classList.remove("midi-playing"),f=null),f=new Qt(U,D,h,T,y,o,P),s.value="",a.selectedIndex=0,f&&(d.textContent=f.formatTime(f.getTotalTime()),r.textContent="0:00",c.style.left="0%",u.style.width="0%")}catch(S){console.error("Error loading MIDI file: ",S),i.innerHTML="Error loading MIDI file"}}function v(g){let E=new nt.Midi;E.header=g.header;let M=E.addTrack();return g.tracks.forEach(S=>{M.notes.push(...S.notes),S.controlChanges&&Object.values(S.controlChanges).forEach(P=>{P.forEach(U=>{M.addCC(U)})}),S.pitchBends&&S.pitchBends.forEach(P=>{M.addPitchBend(P)})}),E}function p(){o.addEventListener("click",()=>{f&&(f.isPlaying?(o.textContent="Play",o.classList.remove("midi-playing"),h=!0,f.pause()):(o.textContent="Pause",o.classList.add("midi-playing"),h=!1,f.play()))}),t.addEventListener("change",()=>{T=t.checked,f&&f.setLooping(T)}),e.addEventListener("input",()=>{y=parseFloat(e.value),n.textContent=y.toFixed(2)+"x",f&&f.setPlaybackSpeed(y)}),l.addEventListener("mousedown",P=>{f&&(k=!0,M(P),document.addEventListener("mousemove",g),document.addEventListener("mouseup",E))});function g(P){k&&M(P)}function E(){k=!1,document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",E)}function M(P){if(!f)return;const U=l.getBoundingClientRect(),x=Math.max(0,Math.min(U.width,P.clientX-U.left))/U.width*100;c.style.left=`${x}%`,u.style.width=`${x}%`;const $=f.setPlaybackPosition(x);r.textContent=f.formatTime($)}requestAnimationFrame(S);function S(){if(f&&f.isPlaying&&!k){const P=f.getCurrentPosition(),U=f.getProgressPercentage();r.textContent=f.formatTime(P),c.style.left=`${U}%`,u.style.width=`${U}%`}requestAnimationFrame(S)}}}class Qt{constructor(s,i,o=!1,t=!1,e=1,n=null,l=null){this.MIDIData=s,this.onMIDIEvent=i,this.isPlaying=o,this.isLooping=t,this.playbackSpeed=e,this.timeoutId=null,this.maxSimultaneousEvents=15,this.playButton=n,this.originalMIDI=l,this.activeNotes=new Set;const{processedEvents:u,tempoEvents:c}=this.preprocessEvents();this.processedEvents=u,this.tempoEvents=c,this.currentIndex=0,this.startTime=0,this.pauseTime=0,this.totalTime=this.calculateTotalTime(),console.log(this.formatTime(this.totalTime))}preprocessEvents(){if(!this.MIDIData||!this.MIDIData.tracks||this.MIDIData.tracks.length===0)return{processedEvents:[],tempoEvents:[{tick:0,tempo:5e5}]};const s=[],i=[],o=this.MIDIData.header.ticksPerBeat||480;return this.MIDIData.tracks.forEach(t=>{let e=0;t.forEach(n=>{e+=n.deltaTime,n.type==="setTempo"&&i.push({tick:e,tempo:n.microsecondsPerBeat})})}),i.sort((t,e)=>t.tick-e.tick),(i.length===0||i[0].tick>0)&&i.unshift({tick:0,tempo:5e5}),this.MIDIData.tracks.forEach((t,e)=>{let n=0;t.forEach(l=>{if(n+=l.deltaTime,["noteOn","noteOff","controller"].includes(l.type)){const u=this.ticksToMs(n,i,o);s.push({...l,absoluteTick:n,absoluteTime:u,track:e})}})}),this.originalMIDI&&this.originalMIDI.tracks.forEach((t,e)=>{t.pitchBends.forEach(n=>{const l=this.ticksToMs(n.ticks,i,o);s.push({type:"pitchBend",value:n.value,absoluteTick:n.ticks,absoluteTime:l,track:e})})}),s.sort((t,e)=>t.absoluteTick!==e.absoluteTick?t.absoluteTick-e.absoluteTick:t.type==="noteOff"&&e.type==="noteOn"?-1:t.type==="noteOn"&&e.type==="noteOff"?1:t.track-e.track),{processedEvents:s,tempoEvents:i}}ticksToMs(s,i,o){let t=0,e=0,n=i[0].tempo;for(let u=0;u<i.length;u++){const c=i[u];if(c.tick<s){const r=c.tick-e;t+=r/o*(n/1e3),e=c.tick,n=c.tempo}else break}const l=s-e;return t+=l/o*(n/1e3),t}calculateTotalTime(){return this.processedEvents.length===0?0:this.processedEvents[this.processedEvents.length-1].absoluteTime+500}formatTime(s){const i=Math.floor(s/1e3),o=Math.floor(i/60),t=i%60;return`${o}:${t.toString().padStart(2,"0")}`}play(){if(!this.isPlaying){if(this.isPlaying=!0,this.currentIndex>=this.processedEvents.length&&(this.currentIndex=0),this.pauseTime>0)this.startTime=performance.now()-this.pauseTime/this.playbackSpeed;else{const s=this.processedEvents[this.currentIndex]||{absoluteTime:0};this.startTime=performance.now()-s.absoluteTime/this.playbackSpeed,console.log(performance.now()),console.log(s.absoluteTime),console.log(this.playbackSpeed)}this.processEvents(),this.playButton&&(this.playButton.textContent="Pause",this.playButton.classList.add("midi-playing"))}}pause(){if(!this.isPlaying)return;this.pauseTime=this.getCurrentPosition(),this.isPlaying=!1,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null);const s={data:new Uint8Array([224,0,64])};this.onMIDIEvent(s,!0),this.releaseActiveNotes(),this.playButton&&(this.playButton.textContent="Play",this.playButton.classList.contains("midi-playing")&&this.playButton.classList.remove("midi-playing"))}setLooping(s){this.isLooping=s}setPlaybackSpeed(s){s<=0&&(s=.1);const i=this.isPlaying,o=this.getCurrentPosition();i&&this.pause(),this.playbackSpeed=s,this.pauseTime=o,i&&this.play()}getTotalTime(){return this.totalTime}getCurrentPosition(){return this.isPlaying?(performance.now()-this.startTime)*this.playbackSpeed:this.currentIndex<this.processedEvents.length?this.processedEvents[this.currentIndex.absoluteTime]:this.pauseTime||0}getProgressPercentage(){return this.getCurrentPosition()/this.totalTime*100}setPlaybackPosition(s){s<0&&(s=0),s>100&&(s=100);const i=s/100*this.totalTime,o=this.isPlaying;return o&&this.pause(),this.currentIndex=this.findEventIndexByTime(i),this.pauseTime=i,o&&this.play(),i}findEventIndexByTime(s){for(let i=0;i<this.processedEvents.length;i++)if(this.processedEvents[i].absoluteTime>=s)return i;return this.processedEvents.length-1}processEvents(){if(!this.isPlaying||this.processedEvents.length===0)return;const s=this.getCurrentPosition();let i=0;for(;this.currentIndex<this.processedEvents.length&&this.processedEvents[this.currentIndex].absoluteTime<=s;){if(i<=this.maxSimultaneousEvents){const o=this.processedEvents[this.currentIndex];this.processMIDIEvent(o),i+=1}this.currentIndex++}if(this.currentIndex>=this.processedEvents.length)if(this.isLooping)this.currentIndex=0,this.startTime=performance.now(),this.pauseTime=0;else{console.log("Finished"),this.pause();return}this.timeoutId=setTimeout(()=>this.processEvents(),10)}processMIDIEvent(s){let i={};switch(s.type){case"noteOn":i={data:new Uint8Array([144,s.noteNumber,s.velocity||64])};break;case"noteOff":i={data:new Uint8Array([128,s.noteNumber,s.velocity||64])};break;case"controller":i={data:new Uint8Array([176,s.noteNumber,s.velocity||64])};break;case"pitchBend":const o=64+Math.min(64,s.value*64);console.log(o),i={data:new Uint8Array([224,0,o])};break;default:return}this.onMIDIEvent(i,!0)}releaseActiveNotes(){const s={...B,...F,...V};for(const i in s){const o=s[i];if(o.midiPlayerActivated){const t=N.currentTime;o.oscillators&&o.oscillators.forEach(({oscillator:e,gainNode:n})=>{try{e.stop(t),e.disconnect(),n.disconnect()}catch(l){console.error("Error stopping oscillator:",l)}}),o.gainNode&&(o.gainNode.gain.cancelScheduledValues(t),o.gainNode.gain.setValueAtTime(0,t),o.gainNode.disconnect()),B[i]&&delete B[i],F[i]&&delete F[i],V[i]&&delete V[i]}}}}function Yt(){let a=4,s=100,i=64,o=64,t=.3,e=null,n={1:!1,2:!1},l=!1,u=null;const c={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12,o:13,l:14,p:15,";":16,"'":17},r=document.querySelector(".piano"),d={},f=document.querySelectorAll(".piano-white-key"),h=document.querySelectorAll(".piano-black-key"),T=[...f,...h],k=document.querySelector('.piano-settings-button-double[data-key="shift"]'),y=document.querySelector('.piano-settings-button[data-key="z"]'),m=document.querySelector('.piano-settings-button[data-key="x"]'),b=document.querySelector('.piano-info-label[data="octave-display"]'),v=document.querySelector('.piano-settings-button[data-key="c"]'),p=document.querySelector('.piano-settings-button[data-key="v"]'),g=document.querySelector('.piano-info-label[data="velocity-display"]'),E=document.querySelector('.piano-settings-button[data-key="1"]'),M=document.querySelector('.piano-settings-button[data-key="2"]');function S(){b&&(b.textContent=`Current Octave: ${a}`)}function P(){g&&(g.textContent=`Current Velocity: ${s}`)}function U(I){return 60+I+12*(a-4)}function L(){o=64+-n[1]*64+n[2]*64,e===null&&(e=setInterval(I,16));function I(){if(Math.abs(i-o)<1){i=o,clearInterval(e),e=null,w(i);return}i+=(o-i)*t,w(Math.round(i))}function w(O){const R={data:new Uint8Array([224,0,O])};D(R)}}function x(I,w=!0){I&&(w&&!I.classList.contains("active")?I.classList.add("active"):!w&&I.classList.contains("active")&&I.classList.remove("active"))}function $(){l=!0}document.addEventListener("mousedown",$),document.addEventListener("touchstart",$);function le(I){if(l=!1,u){const w=U(parseInt(u.dataset.note)),O={data:new Uint8Array([128,w,s])};D(O),u=null}}document.addEventListener("mouseup",le),document.addEventListener("touchend",le),document.addEventListener("touchcancel",le);function vt(I){I.preventDefault();const w=I.touches[0],O=document.elementFromPoint(w.clientX,w.clientY),R=O&&(O.classList.contains("piano-white-key")||O.classList.contains("piano-black-key"));if(R&&O!==u){if(u){const A=U(parseInt(u.dataset.note)),Q={data:new Uint8Array([128,A,s])};D(Q),x(u,!1)}const J=U(parseInt(O.dataset.note));u=O;const q={data:new Uint8Array([144,J,s])};D(q),x(O,!0)}else if(!R&&u){const J=U(parseInt(u.dataset.note)),q={data:new Uint8Array([128,J,s])};D(q),x(u,!1)}}r.addEventListener("touchmove",vt),T.forEach(I=>{function w(q){q.preventDefault();const A=U(parseInt(I.dataset.note));u=I;const Q={data:new Uint8Array([144,A,s])};D(Q),x(I,!0)}I.addEventListener("mousedown",w),I.addEventListener("touchstart",w);function O(){if(l){const q=U(parseInt(I.dataset.note));u=I;const A={data:new Uint8Array([144,q,s])};D(A),x(I,!0)}}I.addEventListener("mouseenter",O);function R(){if(l){const q=U(parseInt(I.dataset.note));u=I;const A={data:new Uint8Array([128,q,s])};u=null,D(A),x(I,!1)}}I.addEventListener("mouseleave",R);function J(q){if(q.type==="touchend"&&u){const bt=U(parseInt(u.dataset.note)),It={data:new Uint8Array([128,bt,s])};D(It),x(u,!1)}const A=U(parseInt(I.dataset.note));u=I;const Q={data:new Uint8Array([128,A,s])};D(Q),x(I,!1)}I.addEventListener("mouseup",J),I.addEventListener("touchend",J)});function Fe(I){I.preventDefault();const w={data:new Uint8Array([176,64,127])};D(w),x(k,!0)}k.addEventListener("mousedown",Fe),k.addEventListener("touchstart",Fe);function de(){const I={data:new Uint8Array([176,64,0])};D(I),x(k,!1)}k.addEventListener("mouseup",de),k.addEventListener("mouseleave",de),k.addEventListener("touchend",de);function Le(I){I.preventDefault(),a>0&&(a--,S()),x(y,!0)}y.addEventListener("mousedown",Le),y.addEventListener("touchstart",Le);function fe(){x(y,!1)}y.addEventListener("mouseup",fe),y.addEventListener("mouseleave",fe),y.addEventListener("touchend",fe);function De(I){I.preventDefault(),a<7&&(a++,S()),x(m,!0)}m.addEventListener("mousedown",De),m.addEventListener("touchstart",De);function he(){x(m,!1)}m.addEventListener("mouseup",he),m.addEventListener("mouseleave",he),m.addEventListener("touchend",he);function qe(I){I.preventDefault(),s>1&&(s=Math.max(1,s-5),P()),x(v,!0)}v.addEventListener("mousedown",qe),v.addEventListener("touchstart",qe);function me(){x(v,!1)}v.addEventListener("mouseup",me),v.addEventListener("mouseleave",me),v.addEventListener("touchend",me);function Ae(I){I.preventDefault(),s<128&&(s=Math.min(127,s+5),P()),x(p,!0)}p.addEventListener("mousedown",Ae),p.addEventListener("touchstart",Ae);function pe(){x(p,!1)}p.addEventListener("mouseup",pe),p.addEventListener("mouseleave",pe),p.addEventListener("touchend",pe);function Ve(I){I.preventDefault(),n[1]=!0,L(),x(E,!0)}E.addEventListener("mousedown",Ve),E.addEventListener("touchstart",Ve);function ye(){n[1]=!1,L(),x(E,!1)}E.addEventListener("mouseup",ye),E.addEventListener("mouseleave",ye),E.addEventListener("touchend",ye);function _e(I){I.preventDefault(),n[2]=!0,L(),x(M,!0)}M.addEventListener("mousedown",_e),M.addEventListener("touchstart",_e);function ge(){n[2]=!1,L(),x(M,!1)}M.addEventListener("mouseup",ge),M.addEventListener("mouseleave",ge),M.addEventListener("touchend",ge),document.addEventListener("keydown",I=>{let w=I.key.toLowerCase();if(w==="!"&&(w="1"),w==="@"&&(w="2"),w==="shift"){const O={data:new Uint8Array([176,64,127])};D(O),x(k,!0)}if(w==="z"&&(a>0&&(a--,S()),x(y,!0)),w==="x"&&(a<7&&(a++,S()),x(m,!0)),w==="c"&&(s>1&&(s=Math.max(1,s-5),P()),x(v,!0)),w==="v"&&(s<128&&(s=Math.min(127,s+5),P()),x(p,!0)),w==="1"&&(n[1]=!0,L(),x(E,!0)),w==="2"&&(n[2]=!0,L(),x(M,!0)),c[w]!==void 0){const O=c[w],R=U(O),J=Array.from(T).find(q=>{const A=q.querySelector(".key-label");return A&&A.textContent.toLowerCase()===w});if(J&&x(J,!0),!d[w]){d[w]=R;const q={data:new Uint8Array([144,R,s])};D(q)}}}),document.addEventListener("keyup",I=>{let w=I.key.toLowerCase();if(w==="!"&&(w="1"),w==="@"&&(w="2"),w==="shift"){const O={data:new Uint8Array([176,64,0])};D(O),x(k,!1)}if(w==="z"&&x(y,!1),w==="x"&&x(m,!1),w==="c"&&x(v,!1),w==="v"&&x(p,!1),w==="1"&&(n[1]=!1,L(),x(E,!1)),w==="2"&&(n[2]=!1,L(),x(M,!1)),c[w]!==void 0&&d[w]){const O=d[w],R=Array.from(T).find(q=>{const A=q.querySelector(".key-label");return A&&A.textContent.toLowerCase()===w});R&&x(R,!1);const J={data:new Uint8Array([128,O,s])};D(J),delete d[w]}})}
